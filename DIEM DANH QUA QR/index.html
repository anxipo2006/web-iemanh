<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng ƒêi·ªÉm danh L·ªõp 10 - Offline</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; color: #2c3e50; }
        .container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        #reader { width: 100%; max-width: 500px; border: 2px solid #ddd; border-radius: 8px; }
        .controls { margin-top: 10px; }
        button { padding: 10px 20px; cursor: pointer; background-color: #27ae60; color: white; border: none; border-radius: 5px; font-size: 16px; transition: 0.3s; }
        button:hover { background-color: #219150; }
        button#stopBtn { background-color: #c0392b; display: none; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #2980b9; color: white; }
        tr:hover { background-color: #f1f1f1; }
        .status { color: green; font-weight: bold; }
        #exportSection { margin-top: 20px; text-align: right; width: 100%; display: none; }
    </style>
</head>
<body>

    <h1>üìã ƒêi·ªÉm Danh L·ªõp 10C8</h1>

    <div class="container">
        <div id="reader"></div>
        <div id="scanResult" style="font-weight: bold; color: #2980b9; min-height: 24px;"></div>
        
        <div class="controls">
            <button id="startBtn" onclick="startScanning()">üì∑ B·∫≠t Camera</button>
            <button id="stopBtn" onclick="stopScanning()">‚èπ D·ª´ng Camera</button>
        </div>

        <div id="exportSection">
            <button onclick="exportToExcel()">üì• Xu·∫•t file Excel</button>
        </div>
        
        <table id="attendanceTable">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Th·ªùi gian</th>
                    <th>Th√¥ng tin H·ªçc sinh (T·ª´ QR)</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        let html5QrcodeScanner;
        let attendanceList = [];
        
        // --- C·∫§U H√åNH √ÇM THANH ---
        // ƒê·∫£m b·∫£o b·∫°n c√≥ file 'beep.mp3' n·∫±m c√πng th∆∞ m·ª•c v·ªõi file html n√†y
        const scanSound = new Audio('beep.mp3'); 

        // 1. H√†m kh·ªüi ƒë·ªông Camera
        function startScanning() {
            // M·∫πo: Ph√°t √¢m thanh nh·ªè r·ªìi t·∫Øt ngay ƒë·ªÉ tr√¨nh duy·ªát "m·ªü kh√≥a" quy·ªÅn ph√°t √¢m thanh tr√™n ƒëi·ªán tho·∫°i
            scanSound.play().then(() => {
                scanSound.pause();
                scanSound.currentTime = 0;
            }).catch(() => {}); // B·ªè qua l·ªói n·∫øu ch∆∞a c√≥ file

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            // Kh·ªüi t·∫°o m√°y qu√©t
            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            // ∆Øu ti√™n camera sau (environment)
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                alert("L·ªói kh·ªüi ƒë·ªông camera: " + err);
                stopScanning();
            });
        }

        // 2. H√†m x·ª≠ l√Ω khi qu√©t th√†nh c√¥ng
        function onScanSuccess(decodedText, decodedResult) {
            // Ki·ªÉm tra xem h·ªçc sinh n√†y ƒë√£ ƒëi·ªÉm danh ch∆∞a
            const alreadyChecked = attendanceList.some(item => item.info === decodedText);
            
            if (alreadyChecked) {
                document.getElementById('scanResult').innerHTML = `<span style="color:orange">‚ö†Ô∏è ${decodedText} ƒë√£ ƒëi·ªÉm danh r·ªìi!</span>`;
                return; // Kh√¥ng l√†m g√¨ th√™m
            }

            // --- PH√ÅT √ÇM THANH ---
            // ƒê·∫∑t l·∫°i th·ªùi gian v·ªÅ 0 ƒë·ªÉ n·∫øu qu√©t li√™n t·ª•c v·∫´n k√™u "b√≠p" t·ª´ng c√°i r√µ r√†ng
            scanSound.currentTime = 0; 
            scanSound.play().catch(e => console.log('Kh√¥ng th·ªÉ ph√°t √¢m thanh (thi·∫øu file ho·∫∑c ch∆∞a t∆∞∆°ng t√°c):', e));

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            document.getElementById('scanResult').innerText = `‚úÖ ƒê√£ nh·∫≠n: ${decodedText}`;

            const currentTime = new Date().toLocaleString('vi-VN');
            
            // Th√™m v√†o m·∫£ng d·ªØ li·ªáu
            attendanceList.push({
                stt: attendanceList.length + 1,
                time: currentTime,
                info: decodedText,
                status: "C√≥ m·∫∑t"
            });

            updateTable();
            
            // T·∫°m d·ª´ng qu√©t 1 ch√∫t ƒë·ªÉ tr√°nh qu√©t tr√πng l·∫∑p qu√° nhanh (t√πy ch·ªçn)
            // html5QrcodeScanner.pause();
            // setTimeout(() => html5QrcodeScanner.resume(), 1000);
        }

        // 3. C·∫≠p nh·∫≠t b·∫£ng hi·ªÉn th·ªã
        function updateTable() {
            const tbody = document.querySelector("#attendanceTable tbody");
            tbody.innerHTML = ""; // X√≥a c≈©

            // ƒê·∫£o ng∆∞·ª£c danh s√°ch ƒë·ªÉ ng∆∞·ªùi m·ªõi qu√©t hi·ªán l√™n ƒë·∫ßu (t√πy ch·ªçn)
            // attendanceList.slice().reverse().forEach(...) 
            attendanceList.forEach(student => {
                const row = `<tr>
                    <td>${student.stt}</td>
                    <td>${student.time}</td>
                    <td>${student.info}</td>
                    <td class="status">${student.status}</td>
                </tr>`;
                tbody.innerHTML += row;
            });

            if(attendanceList.length > 0) {
                document.getElementById('exportSection').style.display = 'block';
            }
        }

        // 4. D·ª´ng Camera
        function stopScanning() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear(); // D·ªçn d·∫πp UI
                    resetBtnState();
                }).catch(err => {
                    console.log("L·ªói d·ª´ng camera", err);
                    resetBtnState();
                });
            } else {
                resetBtnState();
            }
        }

        function resetBtnState() {
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('reader').innerHTML = "";
            document.getElementById('scanResult').innerText = "";
        }

        // 5. Xu·∫•t ra Excel
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const dataForExcel = attendanceList.map(item => ({
                "S·ªë Th·ª© T·ª±": item.stt,
                "Th·ªùi Gian Qu√©t": item.time,
                "Th√¥ng Tin H·ªçc Sinh": item.info,
                "Tr·∫°ng Th√°i": item.status
            }));

            const ws = XLSX.utils.json_to_sheet(dataForExcel);
            XLSX.utils.book_append_sheet(wb, ws, "DiemDanh");
            const fileName = `DiemDanh_Lop10_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>
